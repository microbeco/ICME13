<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Metagenomics | ICME 13 - Rome Edition</title>
  <meta name="description" content="Book for for the ICME series courses" />
  <meta name="generator" content="bookdown 0.37 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Metagenomics | ICME 13 - Rome Edition" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Book for for the ICME series courses" />
  <meta name="github-repo" content="microbeco/microbeco.github.io" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Metagenomics | ICME 13 - Rome Edition" />
  
  <meta name="twitter:description" content="Book for for the ICME series courses" />
  

<meta name="author" content="Manuela Coci" />
<meta name="author" content="Luigi Gallucci" />
<meta name="author" content="Davide Corso" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="s-analysis.html"/>
<link rel="next" href="our-metagenomic-practice.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<div style="text-align:center">
<li class="toc-logo"><a href="./"><img src="img/icme_13.png" width="250" height="250"></a></li>
<li><a href="https://www.microbeco.org/icme13-roma-2024/"><strong>ICME 13</strong></a></li>
</div>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#icme-13---rome"><i class="fa fa-check"></i><b>1.1</b> ICME 13 - Rome</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction-to-the-command-line.html"><a href="introduction-to-the-command-line.html"><i class="fa fa-check"></i><b>2</b> Introduction to the command line</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction-to-the-command-line.html"><a href="introduction-to-the-command-line.html#set-up-a-terminal"><i class="fa fa-check"></i><b>2.1</b> Set-up a terminal</a></li>
<li class="chapter" data-level="2.2" data-path="introduction-to-the-command-line.html"><a href="introduction-to-the-command-line.html#working-with-the-command-line"><i class="fa fa-check"></i><b>2.2</b> Working with the command line</a></li>
<li class="chapter" data-level="2.3" data-path="introduction-to-the-command-line.html"><a href="introduction-to-the-command-line.html#playing-around-with-basic-unix-commands"><i class="fa fa-check"></i><b>2.3</b> Playing around with basic UNIX commands</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="introduction-to-the-command-line.html"><a href="introduction-to-the-command-line.html#some-notes"><i class="fa fa-check"></i><b>2.3.1</b> Some notes!</a></li>
<li class="chapter" data-level="2.3.2" data-path="introduction-to-the-command-line.html"><a href="introduction-to-the-command-line.html#creating-and-navigating-directories"><i class="fa fa-check"></i><b>2.3.2</b> Creating and navigating directories</a></li>
<li class="chapter" data-level="2.3.3" data-path="introduction-to-the-command-line.html"><a href="introduction-to-the-command-line.html#creating-a-new-file"><i class="fa fa-check"></i><b>2.3.3</b> Creating a new file</a></li>
<li class="chapter" data-level="2.3.4" data-path="introduction-to-the-command-line.html"><a href="introduction-to-the-command-line.html#copying-renaming-moving-and-deleting-files"><i class="fa fa-check"></i><b>2.3.4</b> Copying, renaming, moving and deleting files</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="s-analysis.html"><a href="s-analysis.html"><i class="fa fa-check"></i><b>3</b> 16s Analysis</a>
<ul>
<li class="chapter" data-level="3.1" data-path="s-analysis.html"><a href="s-analysis.html#commands-and-features-that-we-will-use-in-our-practice"><i class="fa fa-check"></i><b>3.1</b> Commands and features that we will use in our practice</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="s-analysis.html"><a href="s-analysis.html#touch"><i class="fa fa-check"></i><b>3.1.1</b> <code>touch</code></a></li>
<li class="chapter" data-level="3.1.2" data-path="s-analysis.html"><a href="s-analysis.html#echo"><i class="fa fa-check"></i><b>3.1.2</b> <code>echo</code></a></li>
<li class="chapter" data-level="3.1.3" data-path="s-analysis.html"><a href="s-analysis.html#cat"><i class="fa fa-check"></i><b>3.1.3</b> <code>cat</code></a></li>
<li class="chapter" data-level="3.1.4" data-path="s-analysis.html"><a href="s-analysis.html#section"><i class="fa fa-check"></i><b>3.1.4</b> <code>$</code></a></li>
<li class="chapter" data-level="3.1.5" data-path="s-analysis.html"><a href="s-analysis.html#chmod"><i class="fa fa-check"></i><b>3.1.5</b> <code>chmod</code></a></li>
<li class="chapter" data-level="3.1.6" data-path="s-analysis.html"><a href="s-analysis.html#basename"><i class="fa fa-check"></i><b>3.1.6</b> <code>basename</code></a></li>
<li class="chapter" data-level="3.1.7" data-path="s-analysis.html"><a href="s-analysis.html#create-a-shell-scripts"><i class="fa fa-check"></i><b>3.1.7</b> Create a shell scripts</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="s-analysis.html"><a href="s-analysis.html#package-manager"><i class="fa fa-check"></i><b>3.2</b> Package Manager</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="s-analysis.html"><a href="s-analysis.html#conda"><i class="fa fa-check"></i><b>3.2.1</b> Conda</a></li>
<li class="chapter" data-level="3.2.2" data-path="s-analysis.html"><a href="s-analysis.html#mamba-recommended"><i class="fa fa-check"></i><b>3.2.2</b> Mamba (Recommended)</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="s-analysis.html"><a href="s-analysis.html#base-calling"><i class="fa fa-check"></i><b>3.3</b> Base Calling</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="s-analysis.html"><a href="s-analysis.html#guppy"><i class="fa fa-check"></i><b>3.3.1</b> Guppy</a></li>
<li class="chapter" data-level="3.3.2" data-path="s-analysis.html"><a href="s-analysis.html#dorado"><i class="fa fa-check"></i><b>3.3.2</b> Dorado</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="s-analysis.html"><a href="s-analysis.html#filtering-and-trimming"><i class="fa fa-check"></i><b>3.4</b> Filtering and Trimming</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="s-analysis.html"><a href="s-analysis.html#nanofilt"><i class="fa fa-check"></i><b>3.4.1</b> NanoFilt</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="s-analysis.html"><a href="s-analysis.html#subsetting"><i class="fa fa-check"></i><b>3.5</b> Subsetting</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="s-analysis.html"><a href="s-analysis.html#bbmap-tools"><i class="fa fa-check"></i><b>3.5.1</b> BBMAP Tools</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="s-analysis.html"><a href="s-analysis.html#taxonomic-assignment"><i class="fa fa-check"></i><b>3.6</b> Taxonomic Assignment</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="s-analysis.html"><a href="s-analysis.html#emu"><i class="fa fa-check"></i><b>3.6.1</b> EMU</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="metagenomics.html"><a href="metagenomics.html"><i class="fa fa-check"></i><b>4</b> Metagenomics</a>
<ul>
<li class="chapter" data-level="4.1" data-path="metagenomics.html"><a href="metagenomics.html#reads-quality-check"><i class="fa fa-check"></i><b>4.1</b> Reads Quality Check</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="metagenomics.html"><a href="metagenomics.html#bbmap-stats.sh"><i class="fa fa-check"></i><b>4.1.1</b> BBMap / <code>stats.sh</code></a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="metagenomics.html"><a href="metagenomics.html#assembly"><i class="fa fa-check"></i><b>4.2</b> Assembly</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="metagenomics.html"><a href="metagenomics.html#flye-metaflye"><i class="fa fa-check"></i><b>4.2.1</b> Flye (Metaflye)</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="metagenomics.html"><a href="metagenomics.html#read-mapping"><i class="fa fa-check"></i><b>4.3</b> Read mapping</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="metagenomics.html"><a href="metagenomics.html#minimap2"><i class="fa fa-check"></i><b>4.3.1</b> Minimap2</a></li>
<li class="chapter" data-level="4.3.2" data-path="metagenomics.html"><a href="metagenomics.html#samtools"><i class="fa fa-check"></i><b>4.3.2</b> samtools</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="metagenomics.html"><a href="metagenomics.html#binning"><i class="fa fa-check"></i><b>4.4</b> Binning</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="metagenomics.html"><a href="metagenomics.html#semibin2"><i class="fa fa-check"></i><b>4.4.1</b> SemiBin2</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="metagenomics.html"><a href="metagenomics.html#mags-quality-check"><i class="fa fa-check"></i><b>4.5</b> MAGs Quality Check</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="metagenomics.html"><a href="metagenomics.html#checkm2"><i class="fa fa-check"></i><b>4.5.1</b> CheckM2</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="metagenomics.html"><a href="metagenomics.html#taxonomic-classification"><i class="fa fa-check"></i><b>4.6</b> Taxonomic Classification</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="metagenomics.html"><a href="metagenomics.html#gtdb-tk"><i class="fa fa-check"></i><b>4.6.1</b> GTDB-Tk</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="metagenomics.html"><a href="metagenomics.html#functional-annotation"><i class="fa fa-check"></i><b>4.7</b> Functional Annotation</a>
<ul>
<li class="chapter" data-level="4.7.1" data-path="metagenomics.html"><a href="metagenomics.html#anvio"><i class="fa fa-check"></i><b>4.7.1</b> Anvi’o</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="our-metagenomic-practice.html"><a href="our-metagenomic-practice.html"><i class="fa fa-check"></i><b>5</b> Our Metagenomic practice</a>
<ul>
<li class="chapter" data-level="5.1" data-path="our-metagenomic-practice.html"><a href="our-metagenomic-practice.html#orf-prediction"><i class="fa fa-check"></i><b>5.1</b> ORF Prediction</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="our-metagenomic-practice.html"><a href="our-metagenomic-practice.html#prodigal"><i class="fa fa-check"></i><b>5.1.1</b> Prodigal</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="our-metagenomic-practice.html"><a href="our-metagenomic-practice.html#hidden-markov-model"><i class="fa fa-check"></i><b>5.2</b> Hidden Markov Model</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="our-metagenomic-practice.html"><a href="our-metagenomic-practice.html#hmmer"><i class="fa fa-check"></i><b>5.2.1</b> hmmer</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="our-metagenomic-practice.html"><a href="our-metagenomic-practice.html#assembly-quality-check"><i class="fa fa-check"></i><b>5.3</b> Assembly Quality Check</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="our-metagenomic-practice.html"><a href="our-metagenomic-practice.html#quast"><i class="fa fa-check"></i><b>5.3.1</b> Quast</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="our-metagenomic-practice.html"><a href="our-metagenomic-practice.html#web-tools-annotations"><i class="fa fa-check"></i><b>5.4</b> Web Tools Annotations</a></li>
<li class="chapter" data-level="5.5" data-path="our-metagenomic-practice.html"><a href="our-metagenomic-practice.html#functional-annotation---mags-based"><i class="fa fa-check"></i><b>5.5</b> Functional Annotation - MAGs based</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">ICME 13 - Rome Edition</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="metagenomics" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">4</span> Metagenomics<a href="metagenomics.html#metagenomics" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The metagenomics sequence are produced using a shotgun approach in which each all the gene present inside the samples were sequenced. This sequencing not only extends taxonomic resolution to the species- or strain-level but also provides potential functional information</p>
<div id="reads-quality-check" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Reads Quality Check<a href="metagenomics.html#reads-quality-check" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>After the basecalling, on the fastq file the “quality check” of the sequence can be performed using stats.sh, a tool inc
luded in BBMap/BBTools</p>
<div id="bbmap-stats.sh" class="section level3 hasAnchor" number="4.1.1">
<h3><span class="header-section-number">4.1.1</span> BBMap / <code>stats.sh</code><a href="metagenomics.html#bbmap-stats.sh" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>stats.sh</code> - Generates basic assembly statistics such as scaffold count, N50, L50, GC content, gap percent, etc. Works with fasta and fastq only (gzipped is fine).</p>
<p><a href="https://github.com/BioInfoTools/BBMap/blob/master/sh/stats.sh">https://github.com/BioInfoTools/BBMap/blob/master/sh/stats.sh</a></p>
</div>
</div>
<div id="assembly" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> Assembly<a href="metagenomics.html#assembly" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>One of the most important step for the metagenomic analysis is the Assembly, in which the reads were compared, aligned and overlapped in order to create longer sequenced called “CONTIGS”.</p>
<div id="flye-metaflye" class="section level3 hasAnchor" number="4.2.1">
<h3><span class="header-section-number">4.2.1</span> Flye (Metaflye)<a href="metagenomics.html#flye-metaflye" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>Setup Conda Env</strong></p>
<pre><code>mamba create -n flye -c conda-forge -c bioconda flye</code></pre>
<p>Flye is a de novo assembler for single molecule sequencing reads using repeat graphs as core data structure. Compared to de Bruijn graphs (which require exact k-mer matches), repeat graphs are built using approximate sequence matches.</p>
<p><a href="https://github.com/fenderglass/Flye">https://github.com/fenderglass/Flye</a></p>
<p>Options used</p>
<ul>
<li><code>--nano-raw ONT</code> regular reads</li>
<li><code>--meta</code> enables the mode for metagenome/uneven coverage assembly</li>
<li><code>--out-dir    &lt;outputdir&gt;</code> Output directory</li>
</ul>
</div>
</div>
<div id="read-mapping" class="section level2 hasAnchor" number="4.3">
<h2><span class="header-section-number">4.3</span> Read mapping<a href="metagenomics.html#read-mapping" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To quantify the coverage, we map the original input reads to the contig</p>
<div id="minimap2" class="section level3 hasAnchor" number="4.3.1">
<h3><span class="header-section-number">4.3.1</span> Minimap2<a href="metagenomics.html#minimap2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A versatile pairwise aligner for genomic and spliced nucleotide sequences, used for evaluate the coverage of the original reads on each previously created contig using pairwise alignment.</p>
<p>A report and two charts are generated with complementary information, showing a summary of the DNA-Seq Alignment results.</p>
<p>This page contains information about the reference genome sequences, the input FASTQ files, and a results overview.</p>
<p>The last section is divided into several subsections: globals, paired information, ACTG content, coverage, mapping quality, insert size, mismatches, and indels.</p>
<p>Minimap2 rates an alignment by the score of the max-scoring sub-segment, excluding introns, and marks the best alignment as primary in SAM.</p>
<p>Sequence Alignment Map (SAM) is a text-based format originally for storing biological sequences aligned to a reference sequence.
Practically, SAM is a TAB-delimited text format consisting of a header section and an alignment section.
Header lines start with ‘@’, while alignment lines do not.</p>
<p><a href="https://github.com/lh3/minimap2">https://github.com/lh3/minimap2</a></p>
<p>Example command line</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb37-1"><a href="metagenomics.html#cb37-1" tabindex="-1"></a><span class="ex">minimap2</span> <span class="at">-ax</span> map-ont ref.fa ont-reads.fq <span class="op">&gt;</span> aln.sam</span></code></pre></div>
<p>Options:
- <code>map-ont</code> Align noisy long reads of ~10% error rate to a reference genome. This is the default mode</p>
</div>
<div id="samtools" class="section level3 hasAnchor" number="4.3.2">
<h3><span class="header-section-number">4.3.2</span> samtools<a href="metagenomics.html#samtools" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Samtools is a package for reading/writing/editing/indexing/viewing SAM/BAM/CRAM format.</p>
<p>A BAM file (*.bam) is a compressed binary version (BGZF format) of a SAM file that is used to represent aligned sequences. This file can be created starting from a SAM (using <code>samtools</code>) file in order to reduce its size.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb38-1"><a href="metagenomics.html#cb38-1" tabindex="-1"></a><span class="ex">samtools</span> sort aln.sam <span class="at">-o</span> aln.bam</span></code></pre></div>
</div>
</div>
<div id="binning" class="section level2 hasAnchor" number="4.4">
<h2><span class="header-section-number">4.4</span> Binning<a href="metagenomics.html#binning" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In metagenomics, binning is the process of grouping reads or contigs and assigning them to individual genome, called “MAGs” (Metagenome Assembled Genomes).</p>
<div id="semibin2" class="section level3 hasAnchor" number="4.4.1">
<h3><span class="header-section-number">4.4.1</span> SemiBin2<a href="metagenomics.html#semibin2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>Setup Conda Env</strong></p>
<pre><code>mamba create -n semibin -c conda-forge -c bioconda semibin</code></pre>
<p>SemiBin is a command line tool for metagenomic binning with semi-supervised siamese neural network using additional information from reference genomes and contigs themselves.
It supports single sample, co-assembly, and multi-samples binning modes.</p>
<p><a href="https://github.com/BigDataBiology/SemiBin">https://github.com/BigDataBiology/SemiBin</a></p>
<p>3 Options are available for this tool:</p>
<ul>
<li><code>single_easy_bin</code>: Running with single-sample binning</li>
<li><code>multi_easy_bin</code>: Running with multi-sample binning</li>
<li><code>co-assembly</code>: samples are co-assembled first (as if the pool of samples were a single sample) and then bins are constructed from this pool of co-assembled contigs.</li>
</ul>
<p>You will need the following inputs:</p>
<ul>
<li>A contig file (contig.fa in the example below)</li>
<li>BAM file(s) from mapping short reads to the contigs, sorted (mapped_reads.sorted.bam in the example below)</li>
</ul>
<p>The <code>single_easy_bin</code> command can be used to produce results in a single step</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb40-1"><a href="metagenomics.html#cb40-1" tabindex="-1"></a><span class="ex">SemiBin2</span> single_easy_bin <span class="at">--sequencing-type</span><span class="op">=</span>long_read <span class="at">--input-fasta</span> assembly.fasta <span class="at">--input-bam</span> aln.bam <span class="at">--output</span> output_folder</span></code></pre></div>
<p>Alternatively, you can train a new model for that sample, by not passing in the <code>--environment</code> flag.</p>
<p>This is the fastest option and should work the best if you have metagenomes from one of our prebuilt habitats (alternatively, you can use the global “habitat” which combines all of them).</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb41-1"><a href="metagenomics.html#cb41-1" tabindex="-1"></a><span class="ex">SemiBin2</span> single_easy_bin <span class="at">--sequencing-type</span><span class="op">=</span>long_read <span class="at">--environment</span> human_gut <span class="at">--input-fasta</span> assembly.fasta <span class="at">--input-bam</span> aln.bam <span class="at">--output</span> output_folder </span></code></pre></div>
</div>
</div>
<div id="mags-quality-check" class="section level2 hasAnchor" number="4.5">
<h2><span class="header-section-number">4.5</span> MAGs Quality Check<a href="metagenomics.html#mags-quality-check" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>As well as the original reads and contigs, also MAGs can be checked to extract the ones that can be considered High Quality.</p>
<div id="checkm2" class="section level3 hasAnchor" number="4.5.1">
<h3><span class="header-section-number">4.5.1</span> CheckM2<a href="metagenomics.html#checkm2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>CheckM2 - Rapid assessment of genome bin quality using machine learning</p>
<p><a href="https://github.com/chklovski/CheckM2">https://github.com/chklovski/CheckM2</a></p>
<p>CheckM2 has universally trained machine learning models it applies regardless of taxonomic lineage to predict the completeness and contamination of genomic bins.
Completeness is the percentage of the mapped genome that were covered by each mag.
Contamination is the inclusion of foreign sequences on the mags</p>
<p>The strain heterogeneity (SH) index indicates the proportion of the contamination that appears to be from the same or similar strains (as determined with an AAI threshold).</p>
<p>In order to extract the completeness and contamination for each Mags, You will also need to download and install the external DIAMOND database that CheckM2 relies on for rapid annotation.</p>
<p><strong>Setup Conda Env and install CheckM2 Database</strong></p>
<div class="sourceCode" id="cb42"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb42-1"><a href="metagenomics.html#cb42-1" tabindex="-1"></a><span class="ex">mamba</span> create <span class="at">-n</span> checkm2 <span class="at">-c</span> bioconda <span class="at">-c</span> conda-forge checkm2</span>
<span id="cb42-2"><a href="metagenomics.html#cb42-2" tabindex="-1"></a><span class="ex">mamba</span> activate checkm2</span>
<span id="cb42-3"><a href="metagenomics.html#cb42-3" tabindex="-1"></a></span>
<span id="cb42-4"><a href="metagenomics.html#cb42-4" tabindex="-1"></a><span class="ex">pip</span> install CheckM2</span>
<span id="cb42-5"><a href="metagenomics.html#cb42-5" tabindex="-1"></a></span>
<span id="cb42-6"><a href="metagenomics.html#cb42-6" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> /path/to/checkm2_database</span>
<span id="cb42-7"><a href="metagenomics.html#cb42-7" tabindex="-1"></a><span class="ex">checkm2</span> database <span class="at">--download</span> <span class="at">--path</span> /path/to/checkm2_database/</span></code></pre></div>
<p>As we can see in the following command, the database path can also be set by using the environmental variable.</p>
<p>The main use of CheckM2 is to predict the completeness and contamination of metagenome-assembled genomes (MAGs)</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="metagenomics.html#cb43-1" tabindex="-1"></a><span class="bu">export</span> <span class="va">CHECKM2DB</span><span class="op">=</span><span class="st">&quot;/path/to/checkm2_database/&quot;</span></span>
<span id="cb43-2"><a href="metagenomics.html#cb43-2" tabindex="-1"></a></span>
<span id="cb43-3"><a href="metagenomics.html#cb43-3" tabindex="-1"></a><span class="ex">checkm2</span> predict <span class="at">--threads</span> 64 <span class="at">--input</span> /path/output/output_bins/ <span class="at">--output-directory</span> output_folder</span></code></pre></div>
</div>
</div>
<div id="taxonomic-classification" class="section level2 hasAnchor" number="4.6">
<h2><span class="header-section-number">4.6</span> Taxonomic Classification<a href="metagenomics.html#taxonomic-classification" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="gtdb-tk" class="section level3 hasAnchor" number="4.6.1">
<h3><span class="header-section-number">4.6.1</span> GTDB-Tk<a href="metagenomics.html#gtdb-tk" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="setup-conda-env" class="section level4 hasAnchor" number="4.6.1.1">
<h4><span class="header-section-number">4.6.1.1</span> Setup Conda Env<a href="metagenomics.html#setup-conda-env" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<pre><code>mamba create -n gtdbtk -c conda-forge -c bioconda gtdbtk=2.3.2</code></pre>
<p>GTDB-tk - assigning taxonomic classifications</p>
<p><a href="https://github.com/Ecogenomics/GTDBTk">https://github.com/Ecogenomics/GTDBTk</a></p>
<p>GTDB-Tk is the software toolkit used for assigning objective taxonomic classifications to bacterial and archaeal genomes based on the Genome Database Taxonomy (GTDB).
It is designed to work with recent advances that allow hundreds or thousands of metagenome-assembled genomes (MAGs) to be obtained directly from environmental samples.</p>
<p>GTDB-Tk requires an external database that needs to be downloaded and unarchived:</p>
<p><a href="https://ecogenomics.github.io/GTDBTk/installing/index.html#gtdb-tk-reference-data">https://ecogenomics.github.io/GTDBTk/installing/index.html#gtdb-tk-reference-data</a></p>
<p>To perform the taxonomic classification, we use the workflow function <code>classify_wf</code> which consists (internally) of four steps: <em>ani_screen</em>, <em>identify</em>, <em>align</em>, and <em>classify</em></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb45-1"><a href="metagenomics.html#cb45-1" tabindex="-1"></a><span class="ex">gtdbtk</span> classify_wf <span class="at">--genome_dir</span> selected_genomes/ <span class="at">--out_dir</span> classify_wf_out <span class="at">--extension</span> fa <span class="at">--force</span> <span class="at">--cpus</span> 32 <span class="at">--skip_ani_screen</span> <span class="at">--pplacer_cpus</span> 32</span></code></pre></div>
<p>Options used:</p>
<ul>
<li><code>--genome_dir &lt;directory&gt;</code> directory containing genome files in FASTA format<br />
</li>
<li><code>--out_dir &lt;directory&gt;</code> directory to output files</li>
<li><code>--extension fa</code> extension of files to process, gz = gzipped</li>
<li><code>--force</code> continue processing if an error occurs on a single genome</li>
<li><code>--skip_ani_screen</code> Skip the ani_screening step to classify genomes using mash and FastANI</li>
<li><code>--pplacer_cpus 32</code> number of CPUs to use during pplacer placement</li>
</ul>
<p>List of output files:</p>
<ul>
<li>summary.tsv: Classifications for bacterial and archaeal genomes (see the GTDB-Tk documentation for details). Here we will find:
<ul>
<li><em>fastani_reference</em>: indicates the accession number of the reference genome (species) to which a user genome was assigned based on ANI and AF. ANI values are only calculated when a query genome is placed within a defined genus and are evaluated for all reference genomes in that genus.</li>
<li><em>fastani_reference_radius</em>: indicates the species-specific ANI circumscription radius of the reference genomes used to determine if a query genome should be classified to the same species as the reference.
<a href="https://ecogenomics.github.io/GTDBTk/files/summary.tsv.html" class="uri">https://ecogenomics.github.io/GTDBTk/files/summary.tsv.html</a></li>
<li><em>fastani_af</em>: indicates the alignment fraction (AF) between the query and above reference genome.</li>
<li><em>closest_placement_reference</em>: indicates the accession number of the reference genome when a genome is placed on a terminal branch.</li>
<li><em>classification_method</em>: indicates the rule used to classify the genome.</li>
</ul></li>
<li><em>classify.tree.gz</em>: Reference tree in Newick format containing query genomes placed with pplacer.</li>
<li><em>markers_summary.tsv</em>: A summary of unique, duplicated, and missing markers within the 120 bacterial marker set, or the 122 archaeal marker set for each submitted genome.</li>
<li><em>msa.fasta.gz</em>: FASTA file containing MSA of submitted and reference genomes.</li>
<li><em>filtered.tsv</em>: A list of genomes with an insufficient number of amino acids in MSA.</li>
<li><em>log</em>: Log files.</li>
<li><em>failed_genomes.tsv</em>: A list of genomes for which the GTDB-Tk analysis failed, e.g. because Prodigal could not detect any genes.</li>
<li><em>gtdbtk_summary.tsv</em>: A summary table of the GTDB-Tk classification results for all bins</li>
</ul>
<p>The taxonomic classification of each bacterial and archaeal genome is contained in the <code>[prefix].[domain].summary.tsv</code> output files.</p>
<p>A strain identifier is used as a placeholder for the genus name when there is no existing genus name and no binomially named representative genome.
This placeholder genus name is generally derived from the oldest representative genome within the lineage and formed from NCBI organism name or NCBI infraspecific/strain ID.</p>
</div>
</div>
</div>
<div id="functional-annotation" class="section level2 hasAnchor" number="4.7">
<h2><span class="header-section-number">4.7</span> Functional Annotation<a href="metagenomics.html#functional-annotation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="anvio" class="section level3 hasAnchor" number="4.7.1">
<h3><span class="header-section-number">4.7.1</span> Anvi’o<a href="metagenomics.html#anvio" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For the final and detailed analysis of the MAGs (both from short and long reads) several specific tool were developed in the last years (i.e. is Anvi’o).</p>
<p>Anvi’o is a comprehensive platform that brings together many aspects of today’s cutting-edge computational strategies of data-enabled microbiology, including genomics, metagenomics, metatranscriptomics, pangenomics, metapangenomics, phylogenomics, and microbial population genetics in an integrated and easy-to-use fashion through extensive interactive visualization capabilities.</p>
<p><a href="https://anvio.org/">https://anvio.org/</a></p>
<p><a href="https://github.com/merenlab/anvio">https://github.com/merenlab/anvio</a></p>
<p><strong>Setup anvio and download databases</strong></p>
<div class="sourceCode" id="cb46"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb46-1"><a href="metagenomics.html#cb46-1" tabindex="-1"></a><span class="ex">mamba</span> create <span class="at">-y</span> <span class="at">--name</span> anvio-8 python=3.10</span>
<span id="cb46-2"><a href="metagenomics.html#cb46-2" tabindex="-1"></a><span class="ex">mamba</span> activate anvio-8</span>
<span id="cb46-3"><a href="metagenomics.html#cb46-3" tabindex="-1"></a><span class="ex">mamba</span> install <span class="at">-y</span> <span class="at">-c</span> conda-forge <span class="at">-c</span> bioconda python=3.10 <span class="dt">\</span></span>
<span id="cb46-4"><a href="metagenomics.html#cb46-4" tabindex="-1"></a>        sqlite prodigal idba mcl muscle=3.8.1551 famsa hmmer diamond <span class="dt">\</span></span>
<span id="cb46-5"><a href="metagenomics.html#cb46-5" tabindex="-1"></a>        blast megahit spades bowtie2 bwa graphviz <span class="st">&quot;samtools&gt;=1.9&quot;</span> <span class="dt">\</span></span>
<span id="cb46-6"><a href="metagenomics.html#cb46-6" tabindex="-1"></a>        trimal iqtree trnascan-se fasttree vmatch r-base r-tidyverse <span class="dt">\</span></span>
<span id="cb46-7"><a href="metagenomics.html#cb46-7" tabindex="-1"></a>        r-optparse r-stringi r-magrittr bioconductor-qvalue meme ghostscript</span>
<span id="cb46-8"><a href="metagenomics.html#cb46-8" tabindex="-1"></a>        </span>
<span id="cb46-9"><a href="metagenomics.html#cb46-9" tabindex="-1"></a><span class="ex">mamba</span> install <span class="at">-y</span> <span class="at">-c</span> bioconda fastani</span>
<span id="cb46-10"><a href="metagenomics.html#cb46-10" tabindex="-1"></a></span>
<span id="cb46-11"><a href="metagenomics.html#cb46-11" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-L</span> https://github.com/merenlab/anvio/releases/download/v8/anvio-8.tar.gz <span class="dt">\</span></span>
<span id="cb46-12"><a href="metagenomics.html#cb46-12" tabindex="-1"></a>        <span class="at">--output</span> anvio-8.tar.gz</span>
<span id="cb46-13"><a href="metagenomics.html#cb46-13" tabindex="-1"></a>       </span>
<span id="cb46-14"><a href="metagenomics.html#cb46-14" tabindex="-1"></a><span class="fu">sudo</span> apt install build-essential</span>
<span id="cb46-15"><a href="metagenomics.html#cb46-15" tabindex="-1"></a><span class="ex">pip</span> install anvio-8.tar.gz</span>
<span id="cb46-16"><a href="metagenomics.html#cb46-16" tabindex="-1"></a></span>
<span id="cb46-17"><a href="metagenomics.html#cb46-17" tabindex="-1"></a></span>
<span id="cb46-18"><a href="metagenomics.html#cb46-18" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> /SERVER/anvio-db/pfam /SERVER/anvio-db/kegg /SERVER/anvio-db/cazy /SERVER/anvio-db/scg       </span>
<span id="cb46-19"><a href="metagenomics.html#cb46-19" tabindex="-1"></a></span>
<span id="cb46-20"><a href="metagenomics.html#cb46-20" tabindex="-1"></a><span class="ex">anvi-setup-kegg-data</span> <span class="at">--mode</span> KOfam <span class="at">--only-download</span> <span class="at">--kegg-data-dir</span> /SERVER/anvio-db/kegg/</span>
<span id="cb46-21"><a href="metagenomics.html#cb46-21" tabindex="-1"></a><span class="ex">anvi-setup-pfams</span> <span class="at">--pfam-data-dir</span> /SERVER/anvio-db/pfam/</span>
<span id="cb46-22"><a href="metagenomics.html#cb46-22" tabindex="-1"></a><span class="ex">anvi-setup-cazymes</span> <span class="at">--cazyme-data-dir</span> /SERVER/anvio-db/cazy/</span>
<span id="cb46-23"><a href="metagenomics.html#cb46-23" tabindex="-1"></a><span class="ex">anvi-setup-scg-taxonomy</span> <span class="at">--scgs-taxonomy-data-dir</span> /SERVER/anvio-db/scg/ <span class="at">--reset</span></span></code></pre></div>
<p>the following workflow is useful for converting a bunch of genomes into an anvi’o-compatible format. It generates contigs databases from each input FASTA file, and subsequently runs a variety of annotation programs of your choice to populate these databases with some useful information for your downstream work (i.e. functions, single-copy-core genes, taxonomy, etc).</p>
<p>To start things going with this workflow, first ask anvi’o to give you a default workflow-config file for the contigs workflow:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb47-1"><a href="metagenomics.html#cb47-1" tabindex="-1"></a><span class="ex">anvi-run-workflow</span> <span class="at">-w</span> contigs <span class="at">--get-default-config</span> contigs.json</span></code></pre></div>
<p>Used options:
- <code>-w contigs</code> select the different type of “workflow (i.e. contig, metagenome …)
- <code>--get-default-config contigs.json</code> generate a default config file (.json) for a given workflow</p>
<p><a href="https://anvio.org/help/main/workflows/contigs/">https://anvio.org/help/main/workflows/contigs/</a></p>
<p>Here we create a <code>file_list.tsv</code></p>
<div class="sourceCode" id="cb48"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb48-1"><a href="metagenomics.html#cb48-1" tabindex="-1"></a><span class="bu">echo</span> <span class="at">-e</span> <span class="st">&quot;name\tpath&quot;</span> <span class="op">&gt;</span> file_list.tsv <span class="kw">&amp;&amp;</span> <span class="fu">find</span> path/to/selected_genomes <span class="at">-type</span> f <span class="at">-exec</span> sh <span class="at">-c</span> <span class="st">&#39;echo -e &quot;$(basename &quot;{}&quot; .fa)\t{}&quot;&#39;</span> <span class="dt">\;</span> <span class="op">&gt;&gt;</span> file_list.tsv</span></code></pre></div>
<p>If everything looks alright, you can run this workflow the following way from the same folder of file_list.tsv:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb49-1"><a href="metagenomics.html#cb49-1" tabindex="-1"></a><span class="ex">anvi-run-workflow</span> <span class="at">-w</span> contigs <span class="at">-c</span> contigs.json <span class="at">--additional-params</span> <span class="at">--jobs</span> 3</span></code></pre></div>
<p>Finally, perform the annotation using one of the pre-loaded database</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb50-1"><a href="metagenomics.html#cb50-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> 02_CONTIGS/<span class="pp">*</span>.db<span class="kw">;</span> <span class="co"># 02_CONTIGS viene generata da anvi-run-workflow</span></span>
<span id="cb50-2"><a href="metagenomics.html#cb50-2" tabindex="-1"></a><span class="cf">do</span></span>
<span id="cb50-3"><a href="metagenomics.html#cb50-3" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$i</span><span class="st">&quot;</span><span class="kw">;</span></span>
<span id="cb50-4"><a href="metagenomics.html#cb50-4" tabindex="-1"></a>    <span class="ex">anvi-run-cazymes</span> <span class="at">-c</span> <span class="va">$i</span> <span class="at">--cazyme-data-dir</span> path/to/CAZYdb/<span class="kw">;</span></span>
<span id="cb50-5"><a href="metagenomics.html#cb50-5" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<p>and export the annotation</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb51-1"><a href="metagenomics.html#cb51-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> 02_CONTIGS/<span class="pp">*</span>.db<span class="kw">;</span> <span class="co"># 02_CONTIGS viene generata da anvi-run-workflow</span></span>
<span id="cb51-2"><a href="metagenomics.html#cb51-2" tabindex="-1"></a><span class="cf">do</span></span>
<span id="cb51-3"><a href="metagenomics.html#cb51-3" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$i</span><span class="st">&quot;</span><span class="kw">;</span></span>
<span id="cb51-4"><a href="metagenomics.html#cb51-4" tabindex="-1"></a>    <span class="ex">anvi-export-functions</span> <span class="at">-c</span> <span class="va">$i</span></span>
<span id="cb51-5"><a href="metagenomics.html#cb51-5" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="s-analysis.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="our-metagenomic-practice.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["icme13.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
